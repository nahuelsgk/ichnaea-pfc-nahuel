\chapter{Disseny e implementaci\'{o}}
\label{cha:dessign}

En aquest cap\'{i}tol veurem els patrons de dissenys emprats i les tecnologies implementades. Tamb\'{e} descriurem la interf\'{i}cie d'usuari m\'{e}s complexa i el fluxe de les operacions de sistema

\section{Esquema general arquitect\'{o}nic del sistema}
A continuaci\'{o} veiem un gr\`{a}fic amb els principals components del sistema i com es relacionen.

\begin{figure}[h]
  \includegraphics[scale=0.5]{img/design/ArchitectureSoftware.png}
  \caption{Arquitectura del sistema}
  \label{dessign:archsoftware}
\end{figure}
On:
\begin{itemize}
\item Ichnaea Web Application & Services \'{e}s el codi de la aplicaci\'{o} i els serveis HTTP
\item Servidor de correu \'{e}s el servidor SMTP per enviar correus electr\`{o}nics als usuaris
\item Productor-Cua-Consumidor \'{e}s el sistema de cues. Expliquem el paradigma a cap\'{i}tol \ref{dessign:queue_system_overview}. La funci\'{o} \'{e}s gestionar els inicis, fluxes i finals d'execucions de Ichnaea.
\item La base de dades on es guardan on els contiguts i models de dades i resultats.
\end{itemize}

\section{Patr\'{o} de disseny}
Per la implementaci\`{o} del sistema web s'han usat els seg\¨{u}ents patrons de disseny:
  \begin{itemize}
  \item Model-Vista-Controlador amb controlador frontal
  \item Capa de Servei
  \item Injecci\'{o} de depend\`{e}ncies
  \item Repositori de model de dades
  \item Capa de mapejat de dades
  \item View template
  \item Interficies enriquides amb servei webs
  \end{itemize}

\subsection{Esquema del disseny}
\begin{figure}[h]
  \includegraphics[scale=0.4]{img/design/IchnaeaPatterns.png}
  \caption{Patrons de disseny}
  \label{dessign:dessignpatters}
\end{figure}

Els components MVC,Model-Vista-Controlador, amb controlador frontal \'{e}s un disseny t\'{i}pic en les aplicacions webs on:
\begin{itemize}
\item el model \'{e}s una representaci\'{o} de les dades en les que treballa la aplicaci\'{o}
\item la vista transforma el model a un format visible i llegible
\item el controlador frontal rep totes les peticions i les redirigeixs als controladors corresponents
\item el controlador se encarrega de processar les peticcions especifiques
\end{itemize}
L'arquitectura MVC separa la capa de presentaci\'{o} de la l\`{o}gica de domini. La capa de presentaci\'{o} accedeix a la capa de domini mitjançant serveis, injectant depend\'{e}ncies.EXPLICAR INJECCION DE DEPENDENCIAS\\
Els serveis, en aquest cas, contenen l\'{o}gica de Ichnaea. Accedeixen mitjançant les dades repositoris d'objectes. EXPLICAR REPOSITORIS i DAPAMAPPING.

\section{Implementaci\'{o} i tecnologies}
\subsection{Symfony}
Symfony2 \'{e}s un HTTP framework. Nativament implementa una variaci\'{o} del Model-Vista-Controlador amb controlador frontal amb injecci\'{o} de depencies a la capa de serveis. \\
Arquitectonicament, Symfony2 estructura el codi en Bundle, similar als paquets de JAVA. Els ''bundle'' son un conjunt de serveis, entitats i recursos independents entre si. Els bundles implementats son
\begin{itemize}
\item{Bundle de usuaris: UserBundle}
\item{Bundle de matrius: MatrixBundle}
\item{Bundle de trainings: TrainingBundle}
\item{Bundle de serveis webs: ApiBundle}
\item{Bundle de predicci\'{o}: PredictionBundle}
\end{itemize}

\subsection{Recursos}
La estructura de recursos de la aplicaci\'{o} \'{e}s la seg\¨{u}ent:\\
\begin{tabular}{| l | l |}
\hline  Matrius       & matrix/(id) \\ \hline
\hline ''Trainings''  & matrix/(id)/training/(id) \\ \hline
\hline ''Predctions'' & matrix/(id)/training/(id)/prediction/(id) \\ \hline
\end{tabular}
S'ha emprat aquesta estructura de recursos degut a les depencies entre les diferentes entitats. Un ''training'' dep\'{e}n d'una matriu i una predicci\'{o} dep\'{e}n d'un ''training''.

\section{Servei web}
S'ha desenvolupat una llibreria API JSON Restful\cite{apijson} per enriquir les interficies. S'ha emprat aquesta tecnologia per la escalabilitat que aporta i perque en un futur es pogui aprofitar el desenvolupament d'aquesta.
Les operacions, els recursos i el parametres son:\\
\begin{tabular}{ | l | p{7cm} |}
\hline
GET & /api/season/(id) \\ \hline
POST & /api/season/searchByName \\ \hline
GET & /api/variable/(id)/seasonSet \\ \hline
DELETE & /api/variable/(id)/seasonSet/(id)\\ \hline
DELETE & /api/variable/(id)/seasonSet/(id) /component/(id) \\ \hline
DELETE & /api/variable/(id)/seasonSet/(id) /component/(id)/complete\\ \hline
PUT & /api/matrix/(id)/column/(id)\\ \hline
PUT & /api/matrix/(id)/sample/(id)\\ \hline
\end{tabular}


\section{Integraci\'{o} amb el sistema de cues RabbitMQP}
\subsection{Introducci\'{o} a l'arquitectura de cues: AMQP}
\label{dessign:queue_system_overview}
TRADUCIR\\
El estándar AMQP (Advanced Message Queuing Protocol) es un protocolo de estándar abierto en la capa de aplicaciones de un sistema de comunicación. Las características que definen al protocolo AMQP son la orientación a mensajes, encolamiento ("queuing"), enrutamiento (tanto punto-a-punto como publicación-subscripción), exactitud y seguridad.
AMQP define una serie de entidades. Desde la perspectiva de la interconexión las más relevantes son:
El corredor de mensajes: un servidor al que los clientes AMQP se conectan usando el protocolo AMQP. Los corredores de mensajes pueden ejecutarse en un entorno distribuido, pero esta capacidad es específica de la implementación y no está cubierta por la especificación.
\begin{itemize}
    Usuario: un usuario es una entidad que, mediante la presentación de credenciales tales como una contraseña, puede ser autorizado (o puede no ser autorizado) a conectarse a un corredor.
    Conexión: una conexión física usando por ejemplo TCP/IP o SCTP. Una conexión está ligada a un usuario.
    Canal: una conexión lógica que está unida a una conexión. Así pues, la comunicación a través de un canal posee un estado. Aquellos clientes que realicen operaciones concurrentes mediante una misma conexión deben mantener un canal distinto para cada una de ellas. Aquellos clientes que usen un modelo basado en hilos para la concurrencia pueden, por ejemplo, encapsular la declaración del canal en una variable local de cada hebra.
\end{itemize}

\subsection{Consumidors}
\subsubsection{Consumidor ''trainings''}
\subsubsection{Consumidor de prediccions}

\section{Interf\'{i}cies}
\subsection{Interf\'{i}cie de configuraci\'{o} de matrius}
\subsection{Interficies de carrega de matrius per fitxers }



